!function(t,e){if("function"==typeof define&&define.amd)define(["tappy-tcmp","tappy-chromeserialcommunicator","tappy-systemfamily"],e);else if("object"==typeof exports){var n=null;try{n=require("@taptrack/tappy")}catch(i){n=require("tappy")}var a=null;try{a=require("@taptrack/tappy-chromeserialcommunicator")}catch(i){a=require("tappy-chromeserialcommunicator")}var s=null;try{s=require("@taptrack/tappy-systemfamily")}catch(i){s=require("tappy-systemfamily")}module.exports=e(n,a,s)}else t.TappyChromeSerialAutodetector=e(t.Tappy,t.TappyChromeSerialCommunicator,t.TappySystemFamily)}(this,function(t,e,n){var i=function(t,e){return null!==t&&"undefined"!=typeof t[e]},a=function(t,e,n){return i(t,e)?t[e]:n},s={getDevices:function(t){chrome.serial.getDevices(t)},connect:function(t,e,n){chrome.serial.connect(t,e,n)},send:function(t,e,n){chrome.serial.send(t,e,n)},flush:function(t,e){chrome.serial.flush(t,db)},disconnect:function(t,e){chrome.serial.disconnect(t,e)},onReceive:{addListener:function(t){chrome.serial.onReceive.addListener(t)}}},r=function(t){var e=this,n=100;"undefined"==typeof t||null===t?(this.waitTimeout=n,this.serialWrapper=s):(this.waitTimeout=a(t,"waitTimeout",n),this.serialWrapper=a(t,"serialWrapper",s)),this.reportScans=!1,this.hasReported=!1,this.lastStatus=!1,this.cb=function(){},this.statusCb=function(){},this.internalScanCb=function(t){if(0===t.length)e.rawNotifyStatus(!0),e.notifyStatus(!0);else for(var n=0;n<t.length;n++)e.reportScans&&e.handshake(t[n])},this.remainingDeviceCheckCount=0};return r.prototype={createDisconnectTimeout:function(t){this.waitTimeout<0?this.waitTimeout>-10&&t():setTimeout(t,this.waitTimeout)},handshake:function(i){var a=this,s=(i.path,new e(i.path,{serial:a.serialWrapper})),r=new t({communicator:s}),o=new n.Commands.Ping,c=new n.Resolver;r.setMessageListener(function(t){var e=null;try{e=c.resolveResponse(t)}catch(s){console.log(s)}a.reportScans&&null!==e&&n.Responses.Ping.isTypeOf(e)&&r.disconnect(function(){a.cb(i)})}),a.remainingDeviceCheckCount++,a.notifyStatus(),r.connect(function(){r.sendMessage(o)}),a.createDisconnectTimeout(function(){a.remainingDeviceCheckCount--,r.disconnect(),0===a.remainingDeviceCheckCount&&a.notifyStatus()})},notifyStatus:function(t){var e=this,n=e.isScanning();!t&&e.hasReported&&n===e.lastStatus||(e.hasReported=!0,e.lastStatus=n,e.rawNotifyStatus(n))},rawNotifyStatus:function(t){var e=this;e.statusCb(t)},scan:function(){this.reportScans=!0,this.serialWrapper.getDevices(this.internalScanCb)},stop:function(){this.reportScans=!1,this.notifyStatus()},setCallback:function(t){this.cb=t},setStatusCallback:function(t){this.statusCb=t},isScanning:function(){return this.reportScans&&this.remainingDeviceCheckCount>0}},r});